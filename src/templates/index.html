<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>處置條件</title>
    
    <h2>處置條件說明</h2>
    <p>以下條件可能導致股票進入處置：<br>
        <div style="padding-left: 2em;">
            1. 連續三日符合第一款條件。<br>
            2. 連續五日符合第1~8款條件。<br>
            3. 十日內有六日符合第1~8款條件。<br>
            4. 三十日內有十二日符合第1~8款條件。
        </div>
    </p>

    <style>
        .punished_duration {
            color: #d9534f;
            font-size: clamp(0.8em, 2vw, 1em);
            margin-top: 2px;
            border-radius: 4px;
            padding: 2px 4px;
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .card {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 16px;
            margin: 8px;
            display: inline-block;
            text-align: center;
            width: 150px;
            cursor: pointer;
            background-color: #f9f9f9;
        }
        .card:hover {
            background-color: #e9e9e9;
        }
        .card.active {
            background-color: #e9e9e9;
            /* color: white; */
        }
        .details-container {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 16px;
            margin: 16px;
            background-color: #f9f9f9;
        }
        .condition {
            margin: 8px 0;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fff;
        }
        .filter-btn {
            padding: 8px 16px;
            border: 1px solid #888;
            border-radius: 4px;
            background: #fff;
            cursor: pointer;
            margin-left: 4px;
        }
        .filter-btn.active {
            background: #e9e9e9;
            font-weight: bold;
        }
        .toolbar{
            display:flex;
            align-items:center;
            gap:12px;
            flex-wrap:wrap;      /* 太窄時自動換行，但預設會在同一行 */
            margin: 12px 0;
        }
        .toolbar h1{ margin:0; }
        .btn-group{ display:flex; gap:8px; }
        /* 讓互動狀態一眼就懂 */
        .card { border: 1px solid #ccc; border-radius: 8px; padding: 16px; margin: 8px; display: inline-block; text-align: center; width: 150px; background:#f9f9f9; }
        .card--clickable { cursor: pointer; }
        .card--clickable:hover { background-color: #e9e9e9; }
        .card--disabled { cursor: default; opacity: 0.95; } /* or keep same color but無手指 */

    </style>
</head>
<body>
    <div id="notice-toolbar" class="toolbar">
        <h1>待處置清單</h1>
        <div class="btn-group">
            <button id="btn-all" class="filter-btn active" data-source="all">全部</button>
            <button id="btn-tse" class="filter-btn" data-source="TSE">上市</button>
            <button id="btn-otc" class="filter-btn" data-source="OTC">上櫃</button>
        </div>
    </div>
        
    <div id="card-container">
        <!-- Cards will be populated here -->
    </div>

    <div id="details-container" class="details-container" style="display: none;">
        <h1>詳細資訊</h1>
        <h2 id="details-title">股票名稱與代號</h2>
        <div id="triggerd_conditions">
        </div>
        <div id="condition">
            <h3>注意條件</h3>
            <div>第一款 (擇一符合)</div>
            <div class="condition" id="target_info_1">第1款</div>
            <div>第二款 (需全符合)</div>
            <div class="condition" id="target_info_2">第2款</div>
            <div>第三款 (需全符合)</div>
            <div class="condition" id="target_info_3">第3款</div>
            <div>第四款</div>
            <div class="condition" id="target_info_4">第4款</div>
            <div>第五款</div>
            <div class="condition" id="target_info_5">第5款</div>
            <div>第六款</div>
            <div class="condition" id="target_info_6">第6款</div>
            <div>第七款</div>
            <div class="condition" id="target_info_7">第7款</div>
            <div>第八款</div>
            <div class="condition" id="target_info_8">TDR 溢價</div>
        </div>
    </div>

    <div id="punished-toolbar" class="toolbar">
        <h1>已處置清單</h1>
        <div class="btn-group">
            <button id="sort-by-code" class="filter-btn"  data-sortby="code">依代號</button>
            <button id="sort-by-end-date" class="filter-btn" data-sortby="end_date">依時間</button>
        </div>
    </div>

    <div id="punished-container"></div>

    

    <script>
        // 1) 全域狀態：來源 & 排序
        const state = {
            source: 'all',
            sort_by: 'end_date',
        };
        // 全域快取，避免排序時重打 API
        let lastData = [];

        // 取資料
        async function fetchPotentialDisposals({ source = 'all' } = {}) {
            try {
                let url = '/potential_disposals';
                const params = new URLSearchParams();
                if (source && source !== 'all') params.append('source', source);
                if (params.toString()) url += `?${params.toString()}`;

                const res = await fetch(url);
                const data = await res.json();

                lastData = Array.isArray(data) ? data : [];
                renderPotentialDisposals(lastData);
            } catch (err) {
                console.error('fetchPotentialDisposals error:', err);
            }
        }

        // 渲染（待處置不排序；已處置依 state.sort_by 排）
        function renderPotentialDisposals(data) {
            const cardContainer = document.getElementById('card-container');
            const punishedContainer = document.getElementById('punished-container');
            cardContainer.innerHTML = '';
            punishedContainer.innerHTML = '';

            const notice = [];
            const punished = [];
            data.forEach(s => (s["已處置"] ? punished : notice).push(s));

            if (state.sort_by === 'code') {
                punished.sort((a, b) => String(a["證券代號"]).localeCompare(String(b["證券代號"])));
            } else {
                const key = s => s["處置結束時間"] ? `0${s["處置結束時間"]}` : `~`;
                punished.sort((a, b) => key(a).localeCompare(key(b)));
            }

            // 記住目前展開的卡片（股票代號）
            

            const makeCard = (stock) => {
                const card = document.createElement('div');
                const isPunished = !!stock["已處置"];
                card.className = `card ${isPunished ? 'card--disabled' : 'card--clickable'}`;
                if (isPunished) card.setAttribute('aria-disabled', 'true');

                card.innerHTML = `
                    <h2>${stock["證券代號"] ?? ''}</h2>
                    <h3>${stock["證券名稱"] ?? ''}</h3>
                    ${
                    isPunished && stock["處置起始時間"]
                        ? `<div class="punished_duration">
                            ${stock["處置起始時間"] ?? ''}<br>|<br>${stock["處置結束時間"] ?? ''}
                        </div>`
                        : ''
                    }
                `;

                // ✅ 只有「未處置」才可點開/收起詳細
                if (!isPunished) {
                    card.addEventListener('click', async () => {
                    toggleDetails(stock, card);
                    });
                }

                return card;
            };

            notice.forEach(s => cardContainer.appendChild(makeCard(s)));
            punished.forEach(s => punishedContainer.appendChild(makeCard(s)));
        }
        let openStockCode = null;
        // 切換詳細資訊：同一張卡片再點一次就收起
        async function toggleDetails(stock, cardEl) {
            const detailsContainer = document.getElementById('details-container');

            // 如果是同一張卡片，就收起
            if (openStockCode === stock["證券代號"]) {
                openStockCode = null;
                detailsContainer.style.display = 'none';
                // 取消 active 樣式
                document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
                return;
            }

            // 展開新的卡片
            openStockCode = stock["證券代號"];

            // 切換 active 樣式
            document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
            cardEl.classList.add('active');

            // 取條件並顯示
            const conditions = await fetchConditions(stock["證券代號"]);
            showDetails(stock, conditions);
            
            const targetInfo = await fetchTargetInfo(stock["證券代號"]);
            showTargetInfo(stock, targetInfo);
            // 確保在視窗可見（可選）
            detailsContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        document.addEventListener('DOMContentLoaded', () => {
            // ✅ 修正：使用字串 ID
            const srcBtns = ['btn-all', 'btn-tse', 'btn-otc']
                .map(id => document.getElementById(id))
                .filter(Boolean);

            srcBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                srcBtns.forEach(b => b.classList.remove('active'));
                e.currentTarget.classList.add('active');
                state.source = e.currentTarget.dataset.source;   // all / TSE / OTC
                fetchPotentialDisposals({ source: state.source });
                });
            });

            const sortButtons = ['sort-by-code', 'sort-by-end-date']
                .map(id => document.getElementById(id))
                .filter(Boolean);

            sortButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                sortButtons.forEach(b => b.classList.remove('active'));
                e.currentTarget.classList.add('active');
                state.sort_by = e.currentTarget.dataset.sortby;  // code / end_date
                // ✅ 不重打 API，直接用快取資料重渲染
                renderPotentialDisposals(lastData);
                });
            });

            // 初始化
            fetchPotentialDisposals({ source: state.source });
        });

        async function fetchConditions(stockCode) {
            try {
                const response = await fetch(`/stocks/${stockCode}/conditions`);
                return await response.json();
            } catch (error) {
                console.error('Error fetching conditions:', error);
                return [];
            }
        }
        
        async function fetchTargetInfo(stockCode) {
            try {
                const response = await fetch(`/stocks/${stockCode}/targetInfo`);
                return await response.json();
            } catch (error) {
                console.error('Error fetching targetInfo:', error);
                return [];
            }
        }

        function setActiveCard(card) {
            // 移除所有卡片的 active 樣式
            const cards = document.querySelectorAll('.card');
            cards.forEach(c => c.classList.remove('active'));

            // 設置點擊的卡片為 active
            card.classList.add('active');
        }

        function showDetails(stock, conditions) {
            const detailsContainer = document.getElementById('details-container');
            const detailsTitle = document.getElementById('details-title');
            const triggerd_conditionsContainer = document.getElementById('triggerd_conditions');

            detailsTitle.textContent = `${stock["證券名稱"]} (${stock["證券代號"]})`;

            triggerd_conditionsContainer.innerHTML = '';
            conditions.forEach(text => {
                const el = document.createElement('div');
                el.className = 'triggerd_condition';
                el.textContent = text;
                triggerd_conditionsContainer.appendChild(el);
            });

            detailsContainer.style.display = 'block';
        }

        function showTargetInfo(stock, targetInfoDict) {
            for (let i = 1; i <= 7; i++) {
                const div = document.getElementById(`target_info_${i}`);
                div.innerHTML = '';

                const infoList = targetInfoDict[`target_info_${i}`];
                if (infoList && infoList.length > 0) {
                    infoList.forEach(text => {
                        const el = document.createElement('div');
                        el.className = 'triggerd_condition';
                        el.textContent = text;
                        div.appendChild(el);
                    });
                }
            }
        }

        async function fetchDisposedStocks(sortBy = "code") {
            try {
                const response = await fetch(`/disposed_stocks?sort_by=${sortBy}`);
                const data = await response.json();

                // 確保資料正確
                console.log('Disposed Stocks:', data);

                // 獲取已處置卡片容器元素
                const punishedContainer = document.getElementById('punished-container');

                // 清空已處置卡片容器內容
                punishedContainer.innerHTML = '';

                // 將資料插入卡片
                data.forEach(stock => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <h3>${stock["證券代號"]}</h3>
                        <p>處置結束時間: ${stock["處置結束時間"]}</p>
                    `;

                    punishedContainer.appendChild(card);
                });
            } catch (error) {
                console.error('Error fetching punished stocks:', error);
            }
        }

        // 預設載入全部
        fetchPotentialDisposals({ source: 'all', sort_by: 'end_date' });

        // 預設載入已處置清單
        document.addEventListener('DOMContentLoaded', () => {
            fetchDisposedStocks();
        });
    </script>
</body>
</html>